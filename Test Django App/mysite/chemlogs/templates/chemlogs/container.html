{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Container {{container.id}}</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <link rel="stylesheet" href="{% static 'chemlogs/style.css' %}">
    <link rel="icon" type="image/png" href="{% static 'chemlogs/images/icon.png' %}">
</head>
<body onload="setAmount('{{container.computeRawAmount}}')">
    <div class="header">
        <a href="{% url 'chemlogs:chemicalSearch' %}"><img src="{% static 'chemlogs/images/icon.png' %}">
            <h4>ChemLogs</h4></a>
    </div>
    <div class="header-bottom"></div>
    <br>

    <p class="hoverable"><a href="{% url 'chemlogs:chemical' chemical_id=container.contents.chemical.id %}">{{container.contents.chemical}} {{container.getHeader}}</a></p>
    <p style="position: absolute;">{{container.contents.chemical.cas}}</p>
    <p style="position: absolute; right: 6vw;">{{container.getDisplayableAmount}} in stock</p>
    <br>
    <p><strong>Storage Location: {{container.loc}}</strong></p>
    <p><strong>Chemical State: {{container.contents.getInfo}}{% if container.molarity is True %} {{container.molarity}}{% endif %}</strong></p>
    <p><strong>Initial Amount: {{container.getInitialDisplayableAmount}}</strong></p>
    <br>

    <br>
    <!-- this mess is the bottle appearance that can be slid to create a transaction -->
    <div id="slider-bottle" style="height: 35vw; width: 20vw; border: 2vw #314876 solid; border-radius: 4vw; margin: auto; position: relative;"> <!-- bottle body -->
        <div id="slider-contents" style="background-color: #608a8e; width: 100%; max-height: 100%; position: absolute; bottom: 0vw; z-index: -1;"> <!-- stuff inside bottle -->
            <div style="position: relative; left: 23.5vw; bottom: 2.3vw; display: flex; align-items: center; gap: 1.5vw;"> <!-- marker/label of amount -->
                <div style="height: 1vw; width: 4vw; background-color: #608a8e;"></div>
                <p id="slider-amount">{{container.computeAmount}}</p>
            </div>
        </div>
        <div style="height: 5vw; width: 12vw; border: 2vw #314876 solid; border-radius: 2vw; border-bottom: none; margin: auto; position: relative; bottom: 7vw;"></div> <!-- bottle neck/top -->
    </div>
    <form method="POST">
        {% csrf_token %}
        {{ transact_form }}
        <div class="center" style="padding-top: 2vw;">
            <input type="submit" name="transact" value="Save Transaction">
        </div>
    </form>

    <h3>Transaction History</h3>
    {% if container.noDisplayableTransactions %}
    <p>No transactions to display</p>
    {% else %}
    <table class="indented">
        <tr>
            <th>Time</th>
            <th>Amt ({{container.getUnits}})</th>
            <th>Type</th>
            <th>User</th>
        </tr>
        {% for transaction in container.getTransactionsToDisplay %}
        <tr class="hoverable">
            <td><a href="{% url 'chemlogs:transaction' transaction_id=transaction.id %}">{{transaction.time|date:"m-d-Y, H:i"}}</a></td>
            <td><a href="{% url 'chemlogs:transaction' transaction_id=transaction.id %}">{{transaction.getAbsoluteAmount}}</a></td>
            <td><a href="{% url 'chemlogs:transaction' transaction_id=transaction.id %}">{% if transaction.type == "R" %}Reset{% elif transaction.amount > 0 %}Added{% else %}Removed{% endif %}</a></td>
            <td><a href="{% url 'chemlogs:transaction' transaction_id=transaction.id %}">{{transaction.user}}</a></td>
        </tr>
        {% endfor %}
    </table>
    {% endif %}

    <script src="{% static 'chemlogs/chemScript.js' %}"> </script>

    <script type="text/javascript"> // slider control for creating a transaction
    slider = document.getElementById("slider-bottle");
    contents = document.getElementById("slider-contents")
    maxAmount = '{{container.initial_value}}';
    function vwToPx() { // 1vw but in px
        return document.documentElement.clientWidth / 100;
    }
    function getOffset() { // adjust for the 2vw bottom border
        return 2 * vwToPx();
    }
    function getBottleHeightPx() {
        bottleHeightVw = 35; // vw height of bottle
        return bottleHeightVw * vwToPx();
    }
    slider.onclick = function(event) {
        var rect = slider.getBoundingClientRect();
        var y = rect.bottom - event.clientY;  // cursor y distance from bottom of bottle
        newAmount = (y-getOffset()) * maxAmount / (getBottleHeightPx());
        newAmount = Math.min(newAmount, maxAmount);
        newAmount = Math.max(newAmount, 0);
        newAmount = Math.round(newAmount);
        setAmount(newAmount, y);
    }

    // show the value that the user is changing container amount to.
    // (also used to show current amount)
    function setAmount(newAmount, y) {
        if (!y) {
            // find y from newAmount (whereas above we do the opposite)
            y = newAmount * getBottleHeightPx() / maxAmount + getOffset();
        }
        document.getElementById("slider-amount").innerHTML = newAmount;
        document.getElementById("new_amount").value = newAmount; // views.py reads this element

        // adjust height of contents + label
        if (newAmount == maxAmount) {
            contents.style.height = "100%"; // don't appear to overflow container
        } else {
            contents.style.height = "calc(" + y + "px - 2vw)";
        }
    }

    </script>

</body>
</html>